<!DOCTPYE html>
<html>
   <head>
      <meta charset="UTF-8">
      <style>
         * {
            margin: 1em;
            user-select: none;
         }
         #start {
            cursor : pointer;
         }
         .table {
            display: table;
            border-collapse: collapse;
         }
         .row {
            display: table-row;
         }
         .cell, .cell_check {
            display: table-cell;
            width: 50px;
            height: 50px;
            border: 1px solid rgb(0, 0, 0);
            text-align : center;
            vertical-align: middle;
            color: transparent;
         }
      </style>
   </head>
   <body>
      <button id = "start" type = "button"> 開始 </button>
      <button id = "reset" disabled = "disabled" type = "button"> 重置 </button>
      <div class = "table">
         <div class = "row">
            <div class = "cell"></div>
            <div class = "cell"></div>
            <div class = "cell"></div>
         </div>
         <div class = "row">
            <div class = "cell"></div>
            <div class = "cell"></div>
            <div class = "cell"></div>
         </div>
         <div class = "row">
            <div class = "cell"></div>
            <div class = "cell"></div>
            <div class = "cell"></div>
         </div>
      </div>
      <div>
         當前玩家 : <span id = "curr_pleayer"></span>
      </div>
      <div class = "player">O : <span id = "time_O">60.0</span></div>
      <div class = "player">X : <span id = "time_X">60.0</span></div>
      
      <script>
         const start = document.getElementById('start');
         const reset = document.getElementById('reset');
         const curr_pleayer = document.getElementById('curr_pleayer');
         let cells = document.getElementsByClassName('cell');

         let currentstep = 0;
         let time;

         let player_O = {
            name : 'O',
            iswin : 0,
            time : 60000,
            time_id : document.getElementById('time_O')
         }

         let player_X = {
            name : 'X',
            iswin : 0,
            time : 60000,
            time_id : document.getElementById('time_X')
         }

         let player = player_O;

         let win_array = [7, 73, 273, 146, 84, 292, 56, 448];
         
         //game start initiaize and event listerner
         start.addEventListener('click', () => {
            settext(true);
            
            Array.from(cells).forEach((element, index) => {
               cells[index].style.cursor = "pointer";
               cells[index].innerText = player.name;
               
               cells[index].setAttribute("id", index);
               cells[index].addEventListener('mouseover', mouseover_func);
            });

            time = setInterval(() => {
               if(player.time <= 0){
                  alert((player.name == 'O' ? 'X' : player.name) + ' is WIN!!');

                  clearInterval(time);

                  endgame();

                  return;
               }

               player.time = player.time <= 100 ? 0 : player.time - 100;
               player.time_id.innerText = String((player.time / 1000).toFixed(1));
            }, 100);
         });
         
         function mouseover_func(index) {
            index.target.style.color='black';
            index.target.addEventListener('mouseout', mouseout_func);
            index.target.addEventListener('click', click_func);
         }

         function mouseout_func(index) {
            if(index != undefined){
               index.target.style.color='transparent';
            }
         }

         function click_func(index){
            index.target.removeEventListener('click', click_func);
            index.target.removeEventListener('mouseout', mouseout_func);
            index.target.removeEventListener('mouseover', mouseover_func);
            
            currentstep++;
            player.iswin |= (1 << +(index.target.id));

            if(check() == true){
               endgame();

               return;
            }
            
            player = (player.name == 'O') ? player_X : player_O;
            curr_pleayer.innerText = player.name;

            Array.from(cells).forEach((element, index) =>{
               if(cells[index].style.color != 'black')
                  cells[index].innerText = player.name;
            });
         }

         //reset
         reset.addEventListener('click', () => {
            endgame();

            settext(false);

            Array.from(cells).forEach((element, index) => {
               cells[index].innerHTML = "";
               cells[index].style.color = "";
            });
         });

         //data reset
         function endgame() {
            clearInterval(time);
            player = player_O;

            player_O.iswin = 0;
            player_O.time = 60000;

            player_X.iswin = 0;
            player_X.time = 60000;
            
            currentstep = 0;

            Array.from(cells).forEach((element, index) => {
               cells[index].style.cursor = "default";
               cells[index].removeEventListener('click', click_func);
               cells[index].removeEventListener('mouseout', mouseout_func);
               cells[index].removeEventListener('mouseover', mouseover_func);
            });
         }

         function check() {
            for(let i = 0; i < win_array.length; i++){
               if((player.iswin & win_array[i]) == win_array[i]){
                  alert(player.name + ' is WIN!!');

                  return true;
               }
            }

            if(currentstep == 9){
               alert('平手');

               return true;
            }

            return false;
         }

         function settext(compare) {
            start.disabled = compare ? "disabled" : "";
            start.style.cursor = compare ? "default" : "pointer";

            reset.disabled = compare ? "" : "disabled";
            reset.style.cursor = compare ? "pointer" : "";

            curr_pleayer.innerText = compare ? player.name : "";
            curr_pleayer.style.color = compare ? 'black' : 'transparent';

            player_X.time_id.innerText = '60.0';
            player_O.time_id.innerText = '60.0';
         }
      </script>
   </body>
</html>